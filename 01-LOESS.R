## A LOESS simítóról lesz szó


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(data.table)
library(ggplot2)
set.seed(1)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
n <- 101
SimData <- data.table(x = (1:n) + rnorm(n, 0, 0.1))
SimData$y <- sin(SimData$x/n*(2*pi))
SimData$yobs <- SimData$y + rnorm(n, 0, 0.2)
p <- ggplot(SimData, aes(x = x, y = yobs)) + geom_point() +
  geom_line(aes(y = y), color = "orange", lwd = 1)
p


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_smooth(formula = y~x, method = "lm", se = FALSE)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_vline(xintercept = 23.5, color = "red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
span <- 0.75
n*span
ceiling(n*span)
sort(abs(SimData$x-23.5))[ceiling(n*span)]


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
tricube <- function(u, t) ifelse(u<t, (1-(u/t)^3)^3, 0)
curve(tricube(x, 2), to = 3)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SimData$w <- tricube(abs(SimData$x-23.5), sort(abs(SimData$x-23.5))[ceiling(n*span)])
ggplot(SimData, aes(x = x, y = yobs, color = w>0)) + geom_point()


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(SimData, aes(x = x, y = yobs, color = w)) + geom_point()


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
fit <- lm(yobs ~ x, weights = w, data = SimData)
p + geom_vline(xintercept = 23.5, color = "red") +
  geom_abline(intercept = coef(fit)[1], slope = coef(fit)[2])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_abline(intercept = coef(fit)[1], slope = coef(fit)[2]) +
  geom_vline(xintercept = 23.5, color = "red") +
  geom_point(x = 23.5, y = predict(fit, data.table(x = 23.5)), color="red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
loessfun <- function(xin, x, yobs, span) {
  n <- length(x)
  w <- tricube(abs(x-xin), sort(abs(x-xin))[ceiling(n*span)])
  fit <- lm(yobs ~ x, weights = w)
  predict(fit, data.table(x = xin))
}
p + geom_vline(xintercept = 23.5, color = "red") +
  geom_point(x = 23.5, y = loessfun(23.5, SimData$x, SimData$yobs, 0.75), color="red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_vline(xintercept = 48.3, color = "red") +
  geom_point(x = 48.3, y = loessfun(48.3, SimData$x, SimData$yobs, 0.75), color="red")
p + geom_vline(xintercept = 91.2, color = "red") +
  geom_point(x = 91.2, y = loessfun(91.2, SimData$x, SimData$yobs, 0.75), color="red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SmoothData <- data.table(x = seq(0, 101, 0.1))
SmoothData$value <- apply(SmoothData, 1, function(sm)
  loessfun(sm["x"], SimData$x, SimData$yobs, 0.75))
p + geom_line(data = SmoothData, aes(x = x, y = value), color = "red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SmoothData <- CJ(x = seq(0, 101, 0.5), span = c(2/n+1e-10, 0.25, 0.5, 0.75, 1))
SmoothData$value <- apply(SmoothData, 1, function(sm)
  loessfun(sm["x"], SimData$x, SimData$yobs, sm["span"]))

p + geom_line(data = SmoothData[span%in%c(0.25, 0.5, 0.75)],
              aes(x = x, y = value, color = factor(span)))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_line(data = SmoothData[span==1], aes(x = x, y = value), color = "red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_line(data = SmoothData[span==2/n+1e-10], aes(x = x, y = value), color = "red")


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
lm(y ~ x + x^2, data = SimData)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
lm(y ~ x + I(x^2), data = SimData)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
lm(y ~ poly(x, 2), data = SimData)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
predict(lm(y ~ x + I(x^2), data = SimData), data.table(x = 43.9))
predict(lm(y ~ poly(x, 2), data = SimData), data.table(x = 43.9))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
t(cbind(1, poly(SimData$x, 3)))%*%cbind(1, poly(SimData$x, 3))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
lm(y ~ poly(x, 2, raw = TRUE), data = SimData)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
kappa(cbind(1, poly(SimData$x, 3)), exact = TRUE)
kappa(cbind(1, poly(SimData$x, 3, raw = TRUE)), exact = TRUE)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
loessfun <- function(xin, x, yobs, span, degree) {
  n <- length(x)
  w <- tricube(abs(x-xin), sort(abs(x-xin))[ceiling(n*span)])
  fit <- lm(yobs ~ poly(x, degree), weights = w)
  predict(fit, data.table(x = xin))
}


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SmoothData <- CJ(x = seq(0, 101, 0.5), degree = c(1, 2), span = (5:99)/100)
SmoothData$value <- apply(SmoothData, 1, function(sm)
  loessfun(sm["x"], SimData$x, SimData$yobs, sm["span"], sm["degree"]))
p + geom_line(data = SmoothData[span%in%c(0.25, 0.5, 0.75)],
              aes(x = x, y = value, color = factor(span))) + facet_grid(rows = vars(degree))


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SimData$train <- FALSE
SimData$train[sample(1:101, 80)] <- TRUE
ggplot(SimData, aes(x = x, y = yobs, color = train)) + geom_point() +
  geom_line(aes(y = y), color = "orange", lwd = 1)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SmoothData2 <- merge(SimData, CJ(x = unique(SimData$x), degree = 1, span = (3:99)/100), by = "x")
SmoothData2$value <- apply(SmoothData2, 1, function(sm)
  loessfun(sm["x"], SimData$x, SimData$yobs, sm["span"], sm["degree"]))
  
ggplot(SmoothData2[, .(SSE = sum((value-yobs)^2)) , .(span)],
       aes(x = span, y = SSE)) + geom_line()


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
SmoothData3 <- merge(SimData[train==FALSE], CJ(x = unique(SimData[train==FALSE]$x), degree = 1,
                                               span = (3:99)/100), by = "x")
SmoothData3$value <- apply(SmoothData3, 1, function(sm)
  loessfun(sm["x"], SimData[train==TRUE]$x, SimData[train==TRUE]$yobs, sm["span"], sm["degree"]))
ggplot(SmoothData3[, .(SSE = sum((value-yobs)^2)) , .(span)], aes(x = span, y = SSE)) +
  geom_line()


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
optspan <- SmoothData3[, .(SSE = sum((value-yobs)^2)) , .(span)][order(SSE)][1]
optspan


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
p + geom_line(data = SmoothData[span==optspan$span&degree==1],
              aes(x = x, y = value), color = "red")

